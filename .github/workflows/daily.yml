name: daily-picks

on:
  schedule:
    # é€±ä¸€åˆ°é€±äº” 18:00 Asia/Taipei = 10:00 UTC (é€±ä¸€åˆ°é€±äº”)
    # 0 = Sunday, 1 = Monday, ..., 6 = Saturday
    # UTC 10:00 å°æ‡‰å°åŒ—æ™‚é–“ 18:00ï¼Œé€±æœ«ä¸åŸ·è¡Œ
    - cron: "0 10 * * 1-5"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è¨±æ¨é€åˆ° gh-pages åˆ†æ”¯

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Verify package versions
        run: |
          echo "### Python Package Versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pip list | grep -E "(pandas|yfinance|matplotlib)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python -c "import pandas as pd; import yfinance as yf; import matplotlib; print(f'pandas: {pd.__version__}'); print(f'yfinance: {yf.__version__}'); print(f'matplotlib: {matplotlib.__version__}')"

      - name: Install Chinese fonts for matplotlib
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-wqy-zenhei fonts-wqy-microhei
          fc-cache -fv
          echo "Installed fonts:"
          fc-list | grep -i "WenQuanYi" || echo "No WenQuanYi fonts found"

      - name: Install rclone
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash
          rclone version

      # === Google Drive (OAuth) è¨­å®š ===
      # éœ€è¦äº‹å…ˆåœ¨ Repository secrets æ”¾å…¥ï¼š
      # - GDRIVE_CLIENT_ID
      # - GDRIVE_CLIENT_SECRET
      # - GDRIVE_TOKEN_JSON   (å« refresh_token çš„æ•´æ®µ JSON)
      # å¯é¸ï¼š
      # - GDRIVE_ROOT_FOLDER_ID  æŒ‡å®šåŒæ­¥çš„ç›®æ¨™è³‡æ–™å¤¾ IDï¼ˆå»ºè­°ï¼‰
      - name: Configure rclone (Google Drive OAuth)
        env:
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          GDRIVE_TOKEN_JSON: ${{ secrets.GDRIVE_TOKEN_JSON }}
          GDRIVE_ROOT_FOLDER_ID: ${{ secrets.GDRIVE_ROOT_FOLDER_ID || secrets.GDRIVE_FOLDER_ID }}
        run: |
          set -e
          mkdir -p ~/.config/rclone

          # æª¢æŸ¥å¿…è¦çš„ç’°å¢ƒè®Šæ•¸
          if [ -z "${GDRIVE_CLIENT_ID}" ] || [ -z "${GDRIVE_CLIENT_SECRET}" ] || [ -z "${GDRIVE_TOKEN_JSON}" ]; then
            echo "::error::ç¼ºå°‘å¿…è¦çš„ Google Drive èªè­‰è³‡è¨Š"
            echo "è«‹ç¢ºèªä»¥ä¸‹ Secrets å·²è¨­å®šï¼š"
            echo "- GDRIVE_CLIENT_ID"
            echo "- GDRIVE_CLIENT_SECRET"
            echo "- GDRIVE_TOKEN_JSON"
            exit 1
          fi

          # å»ºç«‹ rclone é…ç½®æª”
          {
            echo "[gdrive]"
            echo "type = drive"
            echo "scope = drive"
            echo "client_id = ${GDRIVE_CLIENT_ID}"
            echo "client_secret = ${GDRIVE_CLIENT_SECRET}"
            echo "token = ${GDRIVE_TOKEN_JSON}"
          } > ~/.config/rclone/rclone.conf

          # å¦‚æœæœ‰è¨­å®š root_folder_idï¼Œè¿½åŠ åˆ°è¨­å®šæª”
          if [ -n "${GDRIVE_ROOT_FOLDER_ID}" ]; then
            echo "root_folder_id = ${GDRIVE_ROOT_FOLDER_ID}" >> ~/.config/rclone/rclone.conf
            echo "âœ“ root_folder_id å·²è¨­å®š (é™åˆ¶å­˜å–ç¯„åœåˆ°æŒ‡å®šè³‡æ–™å¤¾)" >> $GITHUB_STEP_SUMMARY
            echo "  Folder ID: ${GDRIVE_ROOT_FOLDER_ID:0:20}..." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ root_folder_id æœªè¨­å®š (å¯å­˜å–æ•´å€‹ Google Drive)" >> $GITHUB_STEP_SUMMARY
            echo "  å»ºè­°è¨­å®š GDRIVE_ROOT_FOLDER_ID æˆ– GDRIVE_FOLDER_ID Secret" >> $GITHUB_STEP_SUMMARY
          fi

          # é¡¯ç¤ºé…ç½®æª”æ¡ˆï¼ˆéš±è—æ•æ„Ÿè³‡è¨Šï¼‰
          echo "### rclone remote configured" >> $GITHUB_STEP_SUMMARY
          echo "Config preview (secrets hidden):" >> $GITHUB_STEP_SUMMARY
          grep -v "client_id\|client_secret\|token" ~/.config/rclone/rclone.conf >> $GITHUB_STEP_SUMMARY || true

          # è¨ºæ–·è³‡è¨Š
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Diagnostic Info" >> $GITHUB_STEP_SUMMARY
          echo "- Config file exists: $(test -f ~/.config/rclone/rclone.conf && echo 'YES' || echo 'NO')" >> $GITHUB_STEP_SUMMARY
          echo "- Config file size: $(wc -c < ~/.config/rclone/rclone.conf) bytes" >> $GITHUB_STEP_SUMMARY
          echo "- Number of lines: $(wc -l < ~/.config/rclone/rclone.conf)" >> $GITHUB_STEP_SUMMARY
          echo "- CLIENT_ID length: ${#GDRIVE_CLIENT_ID}" >> $GITHUB_STEP_SUMMARY
          echo "- CLIENT_SECRET length: ${#GDRIVE_CLIENT_SECRET}" >> $GITHUB_STEP_SUMMARY
          echo "- TOKEN_JSON length: ${#GDRIVE_TOKEN_JSON}" >> $GITHUB_STEP_SUMMARY
          echo "- TOKEN starts with: ${GDRIVE_TOKEN_JSON:0:20}..." >> $GITHUB_STEP_SUMMARY

      # ä½¿ç”¨ Python æ¸¬è©¦ Google Drive OAuth Token
      - name: Test Google Drive OAuth with Python
        timeout-minutes: 2
        env:
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          GDRIVE_TOKEN_JSON: ${{ secrets.GDRIVE_TOKEN_JSON }}
        run: |
          echo "### Python OAuth Test" >> $GITHUB_STEP_SUMMARY
          python tests/test_gdrive_auth.py 2>&1 | tee /tmp/python_test.log
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat /tmp/python_test.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # æ¸¬è©¦ rclone é…ç½®æ˜¯å¦æ­£å¸¸
      - name: Test rclone connection
        timeout-minutes: 2
        run: |
          echo "Testing rclone connection to Google Drive..."

          # é¡¯ç¤ºé…ç½®æª”çš„å¯¦éš›å…§å®¹çµæ§‹ï¼ˆä¸é¡¯ç¤ºå®Œæ•´å€¼ï¼‰
          echo "### Config File Structure" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          sed 's/client_id = .*/client_id = [HIDDEN]/; s/client_secret = .*/client_secret = [HIDDEN]/; s/token = .*/token = [HIDDEN - length: '$(grep "^token = " ~/.config/rclone/rclone.conf | wc -c)' chars]/' ~/.config/rclone/rclone.conf >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # æ¸¬è©¦é€£æ¥ä¸¦æ•ç²éŒ¯èª¤
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Connection Test Result" >> $GITHUB_STEP_SUMMARY
          if rclone about gdrive: --timeout 30s --contimeout 30s 2>&1 | tee /tmp/rclone_test.log; then
            echo "âœ… Connection successful!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Connection failed" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/rclone_test.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No error log available" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "::warning::rclone connection test failed, but continuing anyway"
          fi

      # å…ˆæŠŠé›²ç«¯è³‡æ–™åŒæ­¥åˆ°æœ¬åœ°
      # å¦‚æœæœ‰è¨­å®š root_folder_idï¼ŒåªæœƒåŒæ­¥è©²è³‡æ–™å¤¾çš„å…§å®¹
      - name: Sync data from Google Drive
        timeout-minutes: 5
        run: |
          mkdir -p data
          echo "é–‹å§‹å¾ Google Drive åŒæ­¥è³‡æ–™..."
          echo "ç›®æ¨™: gdrive: (æ ¹ç›®éŒ„æˆ– root_folder_id æŒ‡å®šçš„è³‡æ–™å¤¾)"
          echo "æœ¬åœ°: ./data å’Œ ./taiex.sqlite"

          # ä¸‹è¼‰ taiex.sqlite åˆ°æ ¹ç›®éŒ„
          if rclone ls "gdrive:" | grep -q "taiex.sqlite"; then
            echo "ç™¼ç¾ taiex.sqliteï¼Œä¸‹è¼‰ä¸­..."
            rclone copy "gdrive:taiex.sqlite" "./" -vv --timeout 30s || echo "taiex.sqlite ä¸‹è¼‰å¤±æ•—"
          else
            echo "âš ï¸  Google Drive ä¸­æœªæ‰¾åˆ° taiex.sqlite (é¦–æ¬¡åŸ·è¡Œæœƒè‡ªå‹•å»ºç«‹)"
          fi

          # åŒæ­¥ data è³‡æ–™å¤¾ (æ—¥æœŸå­è³‡æ–™å¤¾)
          # ä½¿ç”¨ --timeout å’Œ --contimeout é¿å…å¡ä½
          rclone sync "gdrive:data" "./data" \
            -vv \
            --log-file rclone.log \
            --timeout 30s \
            --contimeout 60s \
            --retries 3 \
            --low-level-retries 3 \
            --create-empty-src-dirs || true

          # ä¸‹è¼‰ line_id.txt åˆ°æ ¹ç›®éŒ„
          if rclone ls "gdrive:" | grep -q "line_id.txt"; then
            echo "ç™¼ç¾ line_id.txtï¼Œä¸‹è¼‰ä¸­..."
            rclone copy "gdrive:line_id.txt" "./" -vv --timeout 30s || echo "line_id.txt ä¸‹è¼‰å¤±æ•—"
          else
            echo "âš ï¸  Google Drive ä¸­æœªæ‰¾åˆ° line_id.txt"
          fi

      # åŸ·è¡Œä½ çš„ä¸»ç¨‹å¼ï¼ˆæœƒè®€å¯« ./dataï¼‰
      - name: Run Taiwan stock recommendation bot
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
          # å¯é¸åƒæ•¸ï¼ˆå¦‚æœ‰éœ€è¦å°±åœ¨ Secrets æˆ– Variables è¨­å®šï¼‰
          # EXTRA_USER_IDS: ${{ secrets.EXTRA_USER_IDS }}
          # TWSE_CODES: "2330,2317,2303,2454,2603,2615,2881,2882,2886,1101"
          # TOP_K: "10"
        run: python main.py

      # å¾ gh-pages æ‹‰å–èˆŠçš„ HTML æª”æ¡ˆï¼Œè®“ index.html å¯ä»¥åˆ—å‡ºæ‰€æœ‰æ­·å²è³‡æ–™
      - name: Fetch historical HTML files from gh-pages
        continue-on-error: true
        run: |
          echo "å¾ gh-pages åˆ†æ”¯æ‹‰å–æ­·å² HTML æª”æ¡ˆ..."

          # é…ç½® git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # æ‹‰å– gh-pages åˆ†æ”¯
          git fetch origin gh-pages:gh-pages 2>/dev/null || {
            echo "gh-pages åˆ†æ”¯ä¸å­˜åœ¨ï¼ˆå¯èƒ½æ˜¯é¦–æ¬¡åŸ·è¡Œï¼‰"
            exit 0
          }

          # åˆ‡æ›åˆ° gh-pages åˆ†æ”¯
          git checkout gh-pages

          # è¤‡è£½æ‰€æœ‰ HTML æª”æ¡ˆï¼ˆæ’é™¤ index.htmlï¼‰å’Œ images è³‡æ–™å¤¾åˆ°æš«å­˜ç›®éŒ„
          mkdir -p /tmp/old_pages
          cp -r *.html /tmp/old_pages/ 2>/dev/null || echo "ç„¡ HTML æª”æ¡ˆ"
          cp -r images /tmp/old_pages/ 2>/dev/null || echo "ç„¡ images è³‡æ–™å¤¾"

          # åˆ‡å›ä¸»åˆ†æ”¯
          git checkout main

          # å°‡èˆŠæª”æ¡ˆåˆä½µåˆ° docs è³‡æ–™å¤¾ï¼ˆä¸è¦†è“‹æ–°ç”Ÿæˆçš„æª”æ¡ˆï¼‰
          mkdir -p docs/images
          cp -n /tmp/old_pages/*.html docs/ 2>/dev/null || echo "ç„¡èˆŠ HTML æª”æ¡ˆå¯è¤‡è£½"

          # åˆä½µ images è³‡æ–™å¤¾ï¼ˆä¿ç•™æ–°èˆŠåœ–ç‰‡ï¼‰
          if [ -d "/tmp/old_pages/images" ]; then
            cp -rn /tmp/old_pages/images/* docs/images/ 2>/dev/null || echo "ç„¡èˆŠåœ–ç‰‡å¯è¤‡è£½"
          fi

          echo "æ­·å²æª”æ¡ˆåˆä½µå®Œæˆï¼Œç¾åœ¨ docs è³‡æ–™å¤¾å…§å®¹ï¼š"
          ls -la docs/ | head -20

          # é‡æ–°ç”Ÿæˆ index.htmlï¼Œè®“å®ƒåŒ…å«æ‰€æœ‰æ­·å²è³‡æ–™
          python -c "
          import sys
          sys.path.insert(0, '.')
          from modules.html_generator import generate_index_html
          generate_index_html(output_dir='docs')
          print('index.html å·²æ›´æ–°ï¼ŒåŒ…å«æ‰€æœ‰æ­·å²è³‡æ–™')
          "

      # å°‡æ›´æ–°å¾Œçš„è³‡æ–™å›å¯«åˆ°é›²ç«¯
      # å¦‚æœæœ‰è¨­å®š root_folder_idï¼Œåªæœƒä¸Šå‚³åˆ°è©²è³‡æ–™å¤¾
      - name: Sync data back to Google Drive
        timeout-minutes: 5
        continue-on-error: true
        run: |
          echo "é–‹å§‹ä¸Šå‚³è³‡æ–™åˆ° Google Drive..."

          # ä¸Šå‚³ taiex.sqlite åˆ°æ ¹ç›®éŒ„
          if [ -f "./taiex.sqlite" ]; then
            echo "ä¸Šå‚³ taiex.sqlite åˆ°æ ¹ç›®éŒ„..."
            rclone copy "./taiex.sqlite" "gdrive:" \
              -vv \
              --log-file rclone.log \
              --timeout 30s \
              --contimeout 60s \
              --retries 3 \
              --update \
              --checksum || echo "::warning::taiex.sqlite ä¸Šå‚³å¤±æ•—"
          else
            echo "âš ï¸  æ‰¾ä¸åˆ° taiex.sqlite"
          fi

          # ä¸Šå‚³ data è³‡æ–™å¤¾ (æ—¥æœŸå­è³‡æ–™å¤¾)
          if [ -d "./data" ] && [ -n "$(ls -A ./data)" ]; then
            echo "ä¸Šå‚³ data è³‡æ–™å¤¾..."
            echo "æª”æ¡ˆæ•¸é‡: $(find ./data -type f | wc -l)"
            rclone copy "./data" "gdrive:data" \
              -vv \
              --log-file rclone.log \
              --timeout 30s \
              --contimeout 60s \
              --retries 3 \
              --low-level-retries 3 \
              --update \
              --checksum || echo "::warning::data è³‡æ–™å¤¾ä¸Šå‚³å¤±æ•—"
          else
            echo "âš ï¸  data è³‡æ–™å¤¾ç‚ºç©ºæˆ–ä¸å­˜åœ¨"
          fi

      # å¤±æ•—æˆ–æˆåŠŸéƒ½ä¸Šå‚³ rclone æ—¥èªŒï¼Œæ–¹ä¾¿é™¤éŒ¯
      - name: Upload rclone logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rclone-logs
          path: rclone.log

      # æ¸…ç†è¶…é 5 å¤©çš„èˆŠè³‡æ–™ï¼ˆåœ¨éƒ¨ç½²å‰åŸ·è¡Œï¼‰
      - name: Prepare docs directory for deployment
        run: |
          echo "æº–å‚™éƒ¨ç½²è³‡æ–™å¤¾..."
          ls -la docs/ || echo "docs è³‡æ–™å¤¾ç‚ºç©º"
          if [ -d "docs/images" ]; then
            echo "åœ–ç‰‡è³‡æ–™å¤¾å…§å®¹:"
            ls -la docs/images/
          fi

      # éƒ¨ç½²åˆ° GitHub Pagesï¼ˆä½¿ç”¨ keep_files ä¿ç•™èˆŠæª”æ¡ˆï¼‰
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          keep_files: true  # ä¿ç•™èˆŠæª”æ¡ˆï¼Œæ–°æª”æ¡ˆæœƒè¦†è“‹åŒåæª”æ¡ˆ

      # æ¸…ç† gh-pages åˆ†æ”¯ä¸­è¶…é 10 å¤©çš„èˆŠè³‡æ–™
      - name: Clean old data in gh-pages (keep last 10 days)
        continue-on-error: true
        run: |
          # é…ç½® git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # åˆ‡æ›åˆ° gh-pages åˆ†æ”¯
          git fetch origin gh-pages
          git checkout gh-pages

          # åŸ·è¡Œæ¸…ç†è…³æœ¬
          python - <<EOF
          import os
          from datetime import datetime
          import shutil

          # å–å¾—æ‰€æœ‰ HTML æª”æ¡ˆï¼ˆæ’é™¤ index.htmlï¼‰
          html_files = [f for f in os.listdir('.')
                        if f.endswith('.html') and f != 'index.html']

          # è§£ææ—¥æœŸä¸¦æ’åº
          dates = []
          for f in html_files:
              try:
                  date_str = f.replace('.html', '')
                  date = datetime.strptime(date_str, '%Y-%m-%d')
                  dates.append((date, date_str))
              except ValueError:
                  print(f"ç„¡æ³•è§£ææ—¥æœŸ: {f}")

          dates.sort(reverse=True)  # æœ€æ–°çš„åœ¨å‰

          # ä¿ç•™æœ€è¿‘ 10 å¤©ï¼Œåˆªé™¤å…¶ä»–çš„
          files_deleted = False
          if len(dates) > 10:
              print(f"ç™¼ç¾ {len(dates)} å¤©çš„è³‡æ–™ï¼Œä¿ç•™æœ€è¿‘ 10 å¤©")
              for date, date_str in dates[10:]:
                  # åˆªé™¤ HTML æª”æ¡ˆ
                  html_file = f"{date_str}.html"
                  if os.path.exists(html_file):
                      os.remove(html_file)
                      print(f"å·²åˆªé™¤: {html_file}")
                      files_deleted = True

                  # åˆªé™¤å°æ‡‰çš„åœ–ç‰‡è³‡æ–™å¤¾
                  images_dir = os.path.join("images", date_str)
                  if os.path.exists(images_dir):
                      shutil.rmtree(images_dir)
                      print(f"å·²åˆªé™¤: {images_dir}")
                      files_deleted = True

              # å¯«å…¥æ¨™è¨˜æª”æ¡ˆï¼Œå‘Šè¨´å¾ŒçºŒæ­¥é©Ÿæ˜¯å¦éœ€è¦ commit
              with open('/tmp/files_deleted.txt', 'w') as f:
                  f.write('true' if files_deleted else 'false')
          else:
              print(f"ç›®å‰æœ‰ {len(dates)} å¤©çš„è³‡æ–™ï¼ˆâ‰¤10 å¤©ï¼‰ï¼Œç„¡éœ€æ¸…ç†")
              with open('/tmp/files_deleted.txt', 'w') as f:
                  f.write('false')
          EOF

          # å¦‚æœæœ‰åˆªé™¤æª”æ¡ˆï¼Œå‰‡æäº¤è®Šæ›´
          if [ -f "/tmp/files_deleted.txt" ] && grep -q "true" /tmp/files_deleted.txt; then
            echo "æäº¤æ¸…ç†è®Šæ›´..."
            git add -A
            git commit -m "ğŸ—‘ï¸ æ¸…ç†è¶…é 10 å¤©çš„èˆŠè³‡æ–™ (è‡ªå‹•æ¸…ç†)" || echo "ç„¡è®Šæ›´éœ€è¦æäº¤"
            git push origin gh-pages || echo "æ¨é€å¤±æ•—"
          else
            echo "ç„¡éœ€æäº¤è®Šæ›´"
          fi

          # åˆ‡å›ä¸»åˆ†æ”¯
          git checkout main
