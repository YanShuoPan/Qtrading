name: daily-picks

on:
  schedule:
    # é€±ä¸€åˆ°é€±äº” 18:00 Asia/Taipei = 10:00 UTC (é€±ä¸€åˆ°é€±äº”)
    # 0 = Sunday, 1 = Monday, ..., 6 = Saturday
    # UTC 10:00 å°æ‡‰å°åŒ—æ™‚é–“ 18:00ï¼Œé€±æœ«ä¸åŸ·è¡Œ
    - cron: "0 10 * * 1-5"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è¨±æ¨é€åˆ° gh-pages åˆ†æ”¯

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Verify package versions
        run: |
          echo "### Python Package Versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pip list | grep -E "(pandas|yfinance|matplotlib)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python -c "import pandas as pd; import yfinance as yf; import matplotlib; print(f'pandas: {pd.__version__}'); print(f'yfinance: {yf.__version__}'); print(f'matplotlib: {matplotlib.__version__}')"

      - name: Install Chinese fonts for matplotlib
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-wqy-zenhei fonts-wqy-microhei
          fc-cache -fv
          echo "Installed fonts:"
          fc-list | grep -i "WenQuanYi" || echo "No WenQuanYi fonts found"

      - name: Install rclone
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash
          rclone version

      # === Google Drive (OAuth) è¨­å®š ===
      # éœ€è¦äº‹å…ˆåœ¨ Repository secrets æ”¾å…¥ï¼š
      # - GDRIVE_CLIENT_ID
      # - GDRIVE_CLIENT_SECRET
      # - GDRIVE_TOKEN_JSON   (å« refresh_token çš„æ•´æ®µ JSON)
      # å¯é¸ï¼š
      # - GDRIVE_ROOT_FOLDER_ID  æŒ‡å®šåŒæ­¥çš„ç›®æ¨™è³‡æ–™å¤¾ IDï¼ˆå»ºè­°ï¼‰
      - name: Configure rclone (Google Drive OAuth)
        env:
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          GDRIVE_TOKEN_JSON: ${{ secrets.GDRIVE_TOKEN_JSON }}
          GDRIVE_ROOT_FOLDER_ID: ${{ secrets.GDRIVE_ROOT_FOLDER_ID || secrets.GDRIVE_FOLDER_ID }}
        run: |
          set -e
          mkdir -p ~/.config/rclone

          # æª¢æŸ¥å¿…è¦çš„ç’°å¢ƒè®Šæ•¸
          if [ -z "${GDRIVE_CLIENT_ID}" ] || [ -z "${GDRIVE_CLIENT_SECRET}" ] || [ -z "${GDRIVE_TOKEN_JSON}" ]; then
            echo "::error::ç¼ºå°‘å¿…è¦çš„ Google Drive èªè­‰è³‡è¨Š"
            echo "è«‹ç¢ºèªä»¥ä¸‹ Secrets å·²è¨­å®šï¼š"
            echo "- GDRIVE_CLIENT_ID"
            echo "- GDRIVE_CLIENT_SECRET"
            echo "- GDRIVE_TOKEN_JSON"
            exit 1
          fi

          # å»ºç«‹ rclone é…ç½®æª”
          {
            echo "[gdrive]"
            echo "type = drive"
            echo "scope = drive"
            echo "client_id = ${GDRIVE_CLIENT_ID}"
            echo "client_secret = ${GDRIVE_CLIENT_SECRET}"
            echo "token = ${GDRIVE_TOKEN_JSON}"
          } > ~/.config/rclone/rclone.conf

          # å¦‚æœæœ‰è¨­å®š root_folder_idï¼Œè¿½åŠ åˆ°è¨­å®šæª”
          if [ -n "${GDRIVE_ROOT_FOLDER_ID}" ]; then
            echo "root_folder_id = ${GDRIVE_ROOT_FOLDER_ID}" >> ~/.config/rclone/rclone.conf
            echo "âœ“ root_folder_id å·²è¨­å®š (é™åˆ¶å­˜å–ç¯„åœåˆ°æŒ‡å®šè³‡æ–™å¤¾)" >> $GITHUB_STEP_SUMMARY
            echo "  Folder ID: ${GDRIVE_ROOT_FOLDER_ID:0:20}..." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ root_folder_id æœªè¨­å®š (å¯å­˜å–æ•´å€‹ Google Drive)" >> $GITHUB_STEP_SUMMARY
            echo "  å»ºè­°è¨­å®š GDRIVE_ROOT_FOLDER_ID æˆ– GDRIVE_FOLDER_ID Secret" >> $GITHUB_STEP_SUMMARY
          fi

          # é¡¯ç¤ºé…ç½®æª”æ¡ˆï¼ˆéš±è—æ•æ„Ÿè³‡è¨Šï¼‰
          echo "### rclone remote configured" >> $GITHUB_STEP_SUMMARY
          echo "Config preview (secrets hidden):" >> $GITHUB_STEP_SUMMARY
          grep -v "client_id\|client_secret\|token" ~/.config/rclone/rclone.conf >> $GITHUB_STEP_SUMMARY || true

          # è¨ºæ–·è³‡è¨Š
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Diagnostic Info" >> $GITHUB_STEP_SUMMARY
          echo "- Config file exists: $(test -f ~/.config/rclone/rclone.conf && echo 'YES' || echo 'NO')" >> $GITHUB_STEP_SUMMARY
          echo "- Config file size: $(wc -c < ~/.config/rclone/rclone.conf) bytes" >> $GITHUB_STEP_SUMMARY
          echo "- Number of lines: $(wc -l < ~/.config/rclone/rclone.conf)" >> $GITHUB_STEP_SUMMARY
          echo "- CLIENT_ID length: ${#GDRIVE_CLIENT_ID}" >> $GITHUB_STEP_SUMMARY
          echo "- CLIENT_SECRET length: ${#GDRIVE_CLIENT_SECRET}" >> $GITHUB_STEP_SUMMARY
          echo "- TOKEN_JSON length: ${#GDRIVE_TOKEN_JSON}" >> $GITHUB_STEP_SUMMARY
          echo "- TOKEN starts with: ${GDRIVE_TOKEN_JSON:0:20}..." >> $GITHUB_STEP_SUMMARY

      # æ¸¬è©¦ rclone é…ç½®æ˜¯å¦æ­£å¸¸
      - name: Test rclone connection
        timeout-minutes: 2
        run: |
          echo "Testing rclone connection to Google Drive..."

          # é¡¯ç¤ºé…ç½®æª”çš„å¯¦éš›å…§å®¹çµæ§‹ï¼ˆä¸é¡¯ç¤ºå®Œæ•´å€¼ï¼‰
          echo "### Config File Structure" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          sed 's/client_id = .*/client_id = [HIDDEN]/; s/client_secret = .*/client_secret = [HIDDEN]/; s/token = .*/token = [HIDDEN - length: '$(grep "^token = " ~/.config/rclone/rclone.conf | wc -c)' chars]/' ~/.config/rclone/rclone.conf >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # æ¸¬è©¦é€£æ¥ä¸¦æ•ç²éŒ¯èª¤
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Connection Test Result" >> $GITHUB_STEP_SUMMARY
          if rclone about gdrive: --timeout 30s --contimeout 30s 2>&1 | tee /tmp/rclone_test.log; then
            echo "âœ… Connection successful!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Connection failed" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/rclone_test.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No error log available" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "::warning::rclone connection test failed, but continuing anyway"
          fi

      # å…ˆæŠŠé›²ç«¯è³‡æ–™åŒæ­¥åˆ°æœ¬åœ°
      # å¦‚æœæœ‰è¨­å®š root_folder_idï¼ŒåªæœƒåŒæ­¥è©²è³‡æ–™å¤¾çš„å…§å®¹
      - name: Sync data from Google Drive
        timeout-minutes: 5
        run: |
          mkdir -p data
          echo "é–‹å§‹å¾ Google Drive åŒæ­¥è³‡æ–™..."
          echo "ç›®æ¨™: gdrive: (æ ¹ç›®éŒ„æˆ– root_folder_id æŒ‡å®šçš„è³‡æ–™å¤¾)"
          echo "æœ¬åœ°: ./data å’Œ ./taiex.sqlite"

          # ä¸‹è¼‰ taiex.sqlite åˆ°æ ¹ç›®éŒ„
          if rclone ls "gdrive:" | grep -q "taiex.sqlite"; then
            echo "ç™¼ç¾ taiex.sqliteï¼Œä¸‹è¼‰ä¸­..."
            rclone copy "gdrive:taiex.sqlite" "./" -vv --timeout 30s || echo "taiex.sqlite ä¸‹è¼‰å¤±æ•—"
          else
            echo "âš ï¸  Google Drive ä¸­æœªæ‰¾åˆ° taiex.sqlite (é¦–æ¬¡åŸ·è¡Œæœƒè‡ªå‹•å»ºç«‹)"
          fi

          # åŒæ­¥ data è³‡æ–™å¤¾ (æ—¥æœŸå­è³‡æ–™å¤¾)
          # ä½¿ç”¨ --timeout å’Œ --contimeout é¿å…å¡ä½
          rclone sync "gdrive:data" "./data" \
            -vv \
            --log-file rclone.log \
            --timeout 30s \
            --contimeout 60s \
            --retries 3 \
            --low-level-retries 3 \
            --create-empty-src-dirs || true

          # ä¸‹è¼‰ line_id.txt åˆ°æ ¹ç›®éŒ„
          if rclone ls "gdrive:" | grep -q "line_id.txt"; then
            echo "ç™¼ç¾ line_id.txtï¼Œä¸‹è¼‰ä¸­..."
            rclone copy "gdrive:line_id.txt" "./" -vv --timeout 30s || echo "line_id.txt ä¸‹è¼‰å¤±æ•—"
          else
            echo "âš ï¸  Google Drive ä¸­æœªæ‰¾åˆ° line_id.txt"
          fi

      # åŸ·è¡Œä½ çš„ä¸»ç¨‹å¼ï¼ˆæœƒè®€å¯« ./dataï¼‰
      - name: Run Taiwan stock recommendation bot
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
          # å¯é¸åƒæ•¸ï¼ˆå¦‚æœ‰éœ€è¦å°±åœ¨ Secrets æˆ– Variables è¨­å®šï¼‰
          # EXTRA_USER_IDS: ${{ secrets.EXTRA_USER_IDS }}
          # TWSE_CODES: "2330,2317,2303,2454,2603,2615,2881,2882,2886,1101"
          # TOP_K: "10"
        run: python main.py

      # å¾ gh-pages æ‹‰å–èˆŠçš„ HTML æª”æ¡ˆï¼Œè®“ index.html å¯ä»¥åˆ—å‡ºæ‰€æœ‰æ­·å²è³‡æ–™
      - name: Fetch historical HTML files from gh-pages
        continue-on-error: true
        run: |
          echo "å¾ gh-pages åˆ†æ”¯æ‹‰å–æ­·å² HTML æª”æ¡ˆ..."

          # é…ç½® git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # æ¸…ç† rclone.log é¿å…åˆ†æ”¯åˆ‡æ›è¡çª
          rm -f rclone.log

          # æš«å­˜æœ¬åœ°è®Šæ›´ï¼ˆé¿å…åˆ‡æ›åˆ†æ”¯æ™‚è¡çªï¼‰
          git stash push -m "Stash before switching to gh-pages" || echo "ç„¡éœ€ stash"

          # æ‹‰å– gh-pages åˆ†æ”¯
          git fetch origin gh-pages:gh-pages 2>/dev/null || {
            echo "gh-pages åˆ†æ”¯ä¸å­˜åœ¨ï¼ˆå¯èƒ½æ˜¯é¦–æ¬¡åŸ·è¡Œï¼‰"
            exit 0
          }

          # åˆ‡æ›åˆ° gh-pages åˆ†æ”¯
          git checkout gh-pages

          # è¤‡è£½æ‰€æœ‰ HTML æª”æ¡ˆï¼ˆæ’é™¤ index.htmlï¼‰å’Œ images è³‡æ–™å¤¾åˆ°æš«å­˜ç›®éŒ„
          mkdir -p /tmp/old_pages
          cp -r *.html /tmp/old_pages/ 2>/dev/null || echo "ç„¡ HTML æª”æ¡ˆ"
          cp -r images /tmp/old_pages/ 2>/dev/null || echo "ç„¡ images è³‡æ–™å¤¾"

          # åˆ‡å›ä¸»åˆ†æ”¯
          git checkout main

          # å…ˆå‚™ä»½ä»Šå¤©æ–°ç”Ÿæˆçš„æª”æ¡ˆ
          mkdir -p /tmp/new_pages
          cp -r docs/* /tmp/new_pages/ 2>/dev/null || echo "ç„¡æ–°æª”æ¡ˆéœ€å‚™ä»½"

          # å°‡ gh-pages çš„æ‰€æœ‰æª”æ¡ˆè¤‡è£½åˆ° docsï¼ˆå…ˆå»ºç«‹å®Œæ•´çš„æ­·å²è³‡æ–™ï¼‰
          mkdir -p docs/images
          cp -r /tmp/old_pages/*.html docs/ 2>/dev/null || echo "ç„¡èˆŠ HTML æª”æ¡ˆ"

          # è¤‡è£½ images è³‡æ–™å¤¾
          if [ -d "/tmp/old_pages/images" ]; then
            cp -r /tmp/old_pages/images/* docs/images/ 2>/dev/null || echo "ç„¡èˆŠåœ–ç‰‡"
          fi

          # å†å°‡ä»Šå¤©æ–°ç”Ÿæˆçš„æª”æ¡ˆè¦†è“‹å›å»ï¼ˆç¢ºä¿ä»Šå¤©çš„è³‡æ–™æ˜¯æœ€æ–°çš„ï¼‰
          cp -rf /tmp/new_pages/* docs/ 2>/dev/null || echo "ç„¡æ–°æª”æ¡ˆéœ€è¦è¦†è“‹"

          echo "æ­·å²æª”æ¡ˆåˆä½µå®Œæˆï¼Œç¾åœ¨ docs è³‡æ–™å¤¾å…§å®¹ï¼š"
          ls -la docs/ | head -20
          echo ""
          echo "HTML æª”æ¡ˆåˆ—è¡¨:"
          ls -1 docs/*.html 2>/dev/null || echo "ç„¡ HTML æª”æ¡ˆ"

          # é‡æ–°ç”Ÿæˆ index.htmlï¼Œè®“å®ƒåŒ…å«æ‰€æœ‰æ­·å²è³‡æ–™
          python -c "
          import sys
          sys.path.insert(0, '.')
          from modules.html_generator import generate_index_html
          generate_index_html(output_dir='docs')
          print('index.html å·²æ›´æ–°ï¼ŒåŒ…å«æ‰€æœ‰æ­·å²è³‡æ–™')
          "

      # å°‡æ›´æ–°å¾Œçš„è³‡æ–™å›å¯«åˆ°é›²ç«¯
      # å¦‚æœæœ‰è¨­å®š root_folder_idï¼Œåªæœƒä¸Šå‚³åˆ°è©²è³‡æ–™å¤¾
      - name: Sync data back to Google Drive
        timeout-minutes: 5
        continue-on-error: true
        run: |
          echo "é–‹å§‹ä¸Šå‚³è³‡æ–™åˆ° Google Drive..."

          # ä¸Šå‚³ taiex.sqlite åˆ°æ ¹ç›®éŒ„
          if [ -f "./taiex.sqlite" ]; then
            echo "ä¸Šå‚³ taiex.sqlite åˆ°æ ¹ç›®éŒ„..."
            rclone copy "./taiex.sqlite" "gdrive:" \
              -vv \
              --log-file rclone.log \
              --timeout 30s \
              --contimeout 60s \
              --retries 3 \
              --update \
              --checksum || echo "::warning::taiex.sqlite ä¸Šå‚³å¤±æ•—"
          else
            echo "âš ï¸  æ‰¾ä¸åˆ° taiex.sqlite"
          fi

          # ä¸Šå‚³ data è³‡æ–™å¤¾ (æ—¥æœŸå­è³‡æ–™å¤¾)
          if [ -d "./data" ] && [ -n "$(ls -A ./data)" ]; then
            echo "ä¸Šå‚³ data è³‡æ–™å¤¾..."
            echo "æª”æ¡ˆæ•¸é‡: $(find ./data -type f | wc -l)"
            rclone copy "./data" "gdrive:data" \
              -vv \
              --log-file rclone.log \
              --timeout 30s \
              --contimeout 60s \
              --retries 3 \
              --low-level-retries 3 \
              --update \
              --checksum || echo "::warning::data è³‡æ–™å¤¾ä¸Šå‚³å¤±æ•—"
          else
            echo "âš ï¸  data è³‡æ–™å¤¾ç‚ºç©ºæˆ–ä¸å­˜åœ¨"
          fi

      # å¤±æ•—æˆ–æˆåŠŸéƒ½ä¸Šå‚³ rclone æ—¥èªŒï¼Œæ–¹ä¾¿é™¤éŒ¯
      - name: Upload rclone logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rclone-logs
          path: rclone.log

      # æ¸…ç†ä¸è©²éƒ¨ç½²çš„æª”æ¡ˆï¼ˆåœ¨éƒ¨ç½²å‰åŸ·è¡Œï¼‰
      - name: Prepare docs directory for deployment
        run: |
          echo "æº–å‚™éƒ¨ç½²è³‡æ–™å¤¾..."

          # ç§»é™¤è³‡æ–™åº«æª”æ¡ˆï¼ˆä¸æ‡‰è©²éƒ¨ç½²åˆ° GitHub Pagesï¼‰
          if [ -f "docs/taiex.sqlite" ]; then
            echo "âš ï¸  ç™¼ç¾ taiex.sqliteï¼Œç§»é™¤ä¸­..."
            rm -f docs/taiex.sqlite
          fi

          # ç§»é™¤ .gitignore ç­‰ä¸éœ€è¦çš„æª”æ¡ˆ
          rm -f docs/.gitignore docs/.DS_Store

          echo "æª¢æŸ¥ docs è³‡æ–™å¤¾å…§å®¹:"
          ls -la docs/ || echo "docs è³‡æ–™å¤¾ç‚ºç©º"

          if [ -d "docs/images" ]; then
            echo "åœ–ç‰‡è³‡æ–™å¤¾å…§å®¹:"
            ls -la docs/images/ | head -20
          fi

      # éƒ¨ç½²åˆ° GitHub Pagesï¼ˆä½¿ç”¨ keep_files ä¿ç•™èˆŠæª”æ¡ˆï¼‰
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          keep_files: true  # ä¿ç•™èˆŠæª”æ¡ˆï¼Œæ–°æª”æ¡ˆæœƒè¦†è“‹åŒåæª”æ¡ˆ

      # æ¸…ç† gh-pages åˆ†æ”¯ä¸­è¶…é 7 å¤©çš„èˆŠè³‡æ–™
      - name: Clean old data in gh-pages (keep last 7 days)
        continue-on-error: true
        run: |
          # é…ç½® git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # æ¸…ç† rclone.log é¿å…åˆ†æ”¯åˆ‡æ›è¡çª
          rm -f rclone.log

          # æš«å­˜æœ¬åœ°è®Šæ›´ï¼ˆé¿å…åˆ‡æ›åˆ†æ”¯æ™‚è¡çªï¼‰
          git stash push -m "Stash before switching to gh-pages for cleanup" || echo "ç„¡éœ€ stash"

          # ç¢ºä¿æœ‰æœ€æ–°çš„ main åˆ†æ”¯ä»£ç¢¼
          git fetch origin main

          # åˆ‡æ›åˆ° gh-pages åˆ†æ”¯ä¸¦æ‹‰å–æœ€æ–°è®Šæ›´ï¼ˆåŒ…å«å‰›å‰›éƒ¨ç½²çš„æ–°æª”æ¡ˆï¼‰
          git fetch origin gh-pages
          git checkout gh-pages
          git pull origin gh-pages

          # ç§»é™¤ä¸è©²å­˜åœ¨çš„è³‡æ–™åº«æª”æ¡ˆï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "taiex.sqlite" ]; then
            echo "âš ï¸  ç™¼ç¾ taiex.sqlite åœ¨ gh-pages åˆ†æ”¯ä¸­ï¼Œç§»é™¤ä¸­..."
            rm -f taiex.sqlite
            git add taiex.sqlite
            git commit -m "ğŸ§¹ ç§»é™¤éŒ¯èª¤ä¸Šå‚³çš„ taiex.sqlite è³‡æ–™åº«æª”æ¡ˆ" || echo "å·²ç¶“ç§»é™¤"
          fi

          # å¾æœ€æ–°çš„ main åˆ†æ”¯è¤‡è£½ç¨ç«‹çš„ index ç”Ÿæˆè…³æœ¬
          git checkout origin/main -- generate_index_standalone.py

          # é¡¯ç¤ºè¤‡è£½çš„è…³æœ¬ç‰ˆæœ¬ï¼ˆé™¤éŒ¯ç”¨ï¼‰
          echo "æª¢æŸ¥ generate_index_standalone.py æ˜¯å¦åŒ…å«æ˜ŸæœŸå¹¾é‚è¼¯:"
          grep -A 2 "weekday" generate_index_standalone.py | head -5 || echo "âš ï¸ æœªæ‰¾åˆ° weekday ç›¸é—œä»£ç¢¼"

          # åŸ·è¡Œæ­¸æª”è…³æœ¬ï¼ˆå°‡è¶…é 7 å¤©çš„æª”æ¡ˆç§»åˆ° archive è³‡æ–™å¤¾ï¼‰
          python - <<EOF
          import os
          from datetime import datetime
          import shutil

          # è¨­å®šä¿ç•™å¤©æ•¸ï¼ˆèˆ‡ index.html ä½¿ç”¨ç›¸åŒåƒæ•¸ï¼‰
          KEEP_DAYS = 7

          # å–å¾—æ‰€æœ‰ HTML æª”æ¡ˆï¼ˆå¾ docs/ è³‡æ–™å¤¾æƒæï¼Œæ’é™¤ index.htmlï¼‰
          docs_dir = 'docs'
          if not os.path.exists(docs_dir):
              print(f"âš ï¸  {docs_dir} è³‡æ–™å¤¾ä¸å­˜åœ¨")
              exit(0)

          html_files = [f for f in os.listdir(docs_dir)
                        if f.endswith('.html') and f != 'index.html']

          # è§£ææ—¥æœŸä¸¦æ’åº
          dates = []
          for f in html_files:
              try:
                  date_str = f.replace('.html', '')
                  date = datetime.strptime(date_str, '%Y-%m-%d')
                  dates.append((date, date_str))
              except ValueError:
                  print(f"ç„¡æ³•è§£ææ—¥æœŸ: {f}")

          dates.sort(reverse=True)  # æœ€æ–°çš„åœ¨å‰

          # ä¿ç•™æœ€è¿‘ KEEP_DAYS å¤©ï¼Œå°‡å…¶ä»–çš„ç§»åˆ°æ­¸æª”è³‡æ–™å¤¾
          files_archived = False
          if len(dates) > KEEP_DAYS:
              print(f"ç™¼ç¾ {len(dates)} å¤©çš„è³‡æ–™ï¼Œä¿ç•™æœ€è¿‘ {KEEP_DAYS} å¤©ï¼Œæ­¸æª”å…¶ä»–è³‡æ–™")

              # å»ºç«‹æ­¸æª”è³‡æ–™å¤¾
              os.makedirs('archive', exist_ok=True)
              os.makedirs('archive/images', exist_ok=True)

              for date, date_str in dates[KEEP_DAYS:]:
                  # ç§»å‹• HTML æª”æ¡ˆåˆ°æ­¸æª”è³‡æ–™å¤¾ï¼ˆå¾ docs/ ç§»åˆ° archive/ï¼‰
                  html_file = os.path.join(docs_dir, f"{date_str}.html")
                  if os.path.exists(html_file):
                      os.makedirs('archive', exist_ok=True)
                      archive_path = os.path.join('archive', f"{date_str}.html")
                      shutil.move(html_file, archive_path)
                      print(f"å·²æ­¸æª”: {html_file} -> {archive_path}")
                      files_archived = True

                  # ç§»å‹•å°æ‡‰çš„åœ–ç‰‡è³‡æ–™å¤¾åˆ°æ­¸æª”ï¼ˆå¾ docs/images/ ç§»åˆ° archive/images/ï¼‰
                  images_dir = os.path.join(docs_dir, "images", date_str)
                  if os.path.exists(images_dir):
                      os.makedirs(os.path.join('archive', 'images'), exist_ok=True)
                      archive_images_path = os.path.join('archive', 'images', date_str)
                      shutil.move(images_dir, archive_images_path)
                      print(f"å·²æ­¸æª”: {images_dir} -> {archive_images_path}")
                      files_archived = True

              # å¯«å…¥æ¨™è¨˜æª”æ¡ˆï¼Œå‘Šè¨´å¾ŒçºŒæ­¥é©Ÿæ˜¯å¦éœ€è¦ commit
              with open('/tmp/files_archived.txt', 'w') as f:
                  f.write('true' if files_archived else 'false')

              print(f"\nâœ… æ­¸æª”å®Œæˆï¼ä¸»é ä¿ç•™ {KEEP_DAYS} å¤©ï¼ŒèˆŠè³‡æ–™å·²ç§»è‡³ archive/ è³‡æ–™å¤¾")
          else:
              print(f"ç›®å‰æœ‰ {len(dates)} å¤©çš„è³‡æ–™ï¼ˆâ‰¤{KEEP_DAYS} å¤©ï¼‰ï¼Œç„¡éœ€æ­¸æª”")
              with open('/tmp/files_archived.txt', 'w') as f:
                  f.write('false')
          EOF

          # é‡æ–°ç”Ÿæˆä¸»é  index.htmlï¼ˆåŒ…å«æ‰€æœ‰ä¿ç•™çš„æ—¥æœŸï¼‰
          echo "é‡æ–°ç”Ÿæˆä¸»é  index.html..."

          # å…ˆé¡¯ç¤ºç”Ÿæˆå‰çš„ç‹€æ…‹
          echo "ç”Ÿæˆå‰ index.html åŒ…å«çš„æ—¥æœŸ:"
          grep -oP '"\d{4}-\d{2}-\d{2}\.html"' index.html 2>/dev/null | sort -r | head -20 || echo "index.html ä¸å­˜åœ¨æˆ–ç„¡æ³•è§£æ"

          # åˆªé™¤èˆŠçš„ index.htmlï¼Œå¼·åˆ¶é‡æ–°ç”Ÿæˆ
          rm -f index.html

          # é‡æ–°ç”Ÿæˆä¸»é 
          python generate_index_standalone.py || {
            echo "::error::ç”Ÿæˆ index.html å¤±æ•—"
            exit 1
          }

          # å¦‚æœ archive è³‡æ–™å¤¾å­˜åœ¨ï¼Œç”Ÿæˆ archive/index.html
          if [ -d "archive" ]; then
            echo "ç”Ÿæˆæ­¸æª”ç´¢å¼•é  archive/index.html..."
            python - <<'ARCHIVE_EOF'
          import os
          from datetime import datetime

          # æƒæ archive è³‡æ–™å¤¾ä¸­çš„æ‰€æœ‰ HTML æª”æ¡ˆ
          archive_dir = 'archive'
          if not os.path.exists(archive_dir):
              exit(0)

          html_files = [f for f in os.listdir(archive_dir)
                        if f.endswith('.html') and f != 'index.html']
          dates = sorted([f.replace('.html', '') for f in html_files], reverse=True)

          print(f"æ‰¾åˆ° {len(dates)} å€‹æ­¸æª”æ—¥æœŸ")

          # ç”Ÿæˆæ—¥æœŸé …ç›®
          date_items_html = []
          for date in dates:
              try:
                  weekday = datetime.strptime(date, '%Y-%m-%d').strftime('%A')
                  weekday_zh = {
                      'Monday': 'é€±ä¸€', 'Tuesday': 'é€±äºŒ', 'Wednesday': 'é€±ä¸‰',
                      'Thursday': 'é€±å››', 'Friday': 'é€±äº”', 'Saturday': 'é€±å…­', 'Sunday': 'é€±æ—¥'
                  }[weekday]

                  date_items_html.append(f'''
                      <a href="{date}.html" class="date-item">
                          <div class="date-item-date">ğŸ“… {date} ({weekday_zh})</div>
                          <div class="date-item-arrow">â†’</div>
                      </a>
                  ''')
              except ValueError:
                  print(f"ç„¡æ³•è§£ææ—¥æœŸ: {date}")

          date_items_html = '\n'.join(date_items_html)

          # ç”Ÿæˆ archive/index.html
          html_content = f'''<!DOCTYPE html>
          <html lang="zh-TW">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>æ­·å²æ­¸æª” - å°è‚¡æ¨è–¦æ©Ÿå™¨äºº</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", Arial, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }}
                  .container {{
                      max-width: 900px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 20px;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                      overflow: hidden;
                  }}
                  .header {{
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 60px 30px;
                      text-align: center;
                  }}
                  .header h1 {{ font-size: 3em; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }}
                  .header p {{ font-size: 1.2em; opacity: 0.95; }}
                  .content {{ padding: 40px 30px; }}
                  .intro {{ text-align: center; margin-bottom: 40px; color: #666; }}
                  .intro h2 {{ color: #667eea; margin-bottom: 15px; }}
                  .date-list {{ display: grid; gap: 15px; }}
                  .date-item {{
                      display: block;
                      padding: 25px 30px;
                      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                      border-radius: 12px;
                      text-decoration: none;
                      color: #333;
                      transition: transform 0.2s, box-shadow 0.2s;
                      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                  }}
                  .date-item:hover {{ transform: translateX(10px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }}
                  .date-item-date {{ font-size: 1.5em; font-weight: bold; color: #667eea; margin-bottom: 5px; }}
                  .date-item-arrow {{ float: right; font-size: 1.5em; color: #667eea; }}
                  .footer {{ text-align: center; padding: 30px; background: #f5f7fa; color: #666; border-top: 1px solid #e0e0e0; }}
                  .btn {{
                      padding: 12px 30px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      text-decoration: none;
                      border-radius: 25px;
                      font-weight: bold;
                      transition: transform 0.2s;
                      display: inline-block;
                      margin: 20px 0;
                  }}
                  .btn:hover {{ transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }}
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ğŸ“ æ­·å²æ­¸æª”</h1>
                      <p>å°è‚¡æ¨è–¦æ©Ÿå™¨äºº - æ­·å²è³‡æ–™</p>
                  </div>
                  <div class="content">
                      <div class="intro">
                          <a href="../index.html" class="btn">â† å›åˆ°ä¸»é </a>
                          <h2>æ­·å²æ¨è–¦è¨˜éŒ„</h2>
                          <p>é€™è£¡ä¿å­˜äº†æ‰€æœ‰è¶…é 7 å¤©çš„æ­·å²æ¨è–¦è³‡æ–™</p>
                      </div>
                      <div class="date-list">
          {date_items_html if date_items_html else '<div class="intro"><p>ç›®å‰ç„¡æ­¸æª”è³‡æ–™</p></div>'}
                      </div>
                  </div>
                  <div class="footer">
                      <p>âš ï¸ æœ¬è³‡è¨Šåƒ…ä¾›å­¸ç¿’ç ”ç©¶ä½¿ç”¨ï¼Œä¸æ§‹æˆä»»ä½•æŠ•è³‡å»ºè­°</p>
                      <p>æŠ•è³‡æœ‰é¢¨éšªï¼Œè«‹è¬¹æ…è©•ä¼°</p>
                  </div>
              </div>
          </body>
          </html>
          '''

          index_file = os.path.join(archive_dir, 'index.html')
          with open(index_file, 'w', encoding='utf-8') as f:
              f.write(html_content)

          print(f"âœ… archive/index.html å·²ç”Ÿæˆï¼ŒåŒ…å« {len(dates)} å€‹æ­·å²æ—¥æœŸ")
          ARCHIVE_EOF
          fi

          # é¡¯ç¤ºç”Ÿæˆå¾Œçš„ index.html å…§å®¹ï¼ˆé™¤éŒ¯ç”¨ï¼‰
          echo ""
          echo "ç”Ÿæˆå¾Œ index.html åŒ…å«çš„æ—¥æœŸ:"
          grep -oP '"\d{4}-\d{2}-\d{2}\.html"' index.html | sort -r | head -20 || echo "ç„¡æ³•è§£ææ—¥æœŸ"
          echo ""
          echo "æª¢æŸ¥ index.html æ ¼å¼ï¼ˆé¡¯ç¤ºå‰ 3 å€‹æ—¥æœŸé …ç›®ï¼‰:"
          grep -A 3 "date-item-date" index.html | head -12 || echo "ç„¡æ³•æ‰¾åˆ°æ—¥æœŸé …ç›®"

          # å§‹çµ‚æäº¤ index.html çš„æ›´æ–°ï¼ˆç¢ºä¿åŒ…å«æœ€æ–°éƒ¨ç½²çš„æª”æ¡ˆï¼‰
          git add index.html

          # æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•è®Šæ›´éœ€è¦æäº¤
          if git diff --cached --quiet; then
            echo "âš ï¸  index.html ç„¡è®Šæ›´ï¼Œä½†ä»ç„¶å¼·åˆ¶æäº¤ä»¥ç¢ºä¿åŒæ­¥"
            # å³ä½¿æ²’æœ‰è®Šæ›´ï¼Œä¹Ÿä½¿ç”¨ --allow-empty æäº¤
            git commit --allow-empty -m "ğŸ“ æ›´æ–° index.html (ç¢ºä¿åŒæ­¥)"
            git push origin gh-pages || {
              echo "::error::æ¨é€ index.html å¤±æ•—"
              exit 1
            }
          else
            # å¦‚æœæœ‰æ­¸æª”èˆŠæª”æ¡ˆï¼Œä¸€ä½µæäº¤
            if [ -f "/tmp/files_archived.txt" ] && grep -q "true" /tmp/files_archived.txt; then
              echo "æäº¤æ­¸æª”è®Šæ›´å’Œæ›´æ–°çš„ index.html..."
              git add -A
              git commit -m "ğŸ“¦ å°‡è¶…é 7 å¤©çš„è³‡æ–™æ­¸æª”è‡³ archive/ ä¸¦æ›´æ–° index.html"
            else
              echo "æäº¤æ›´æ–°çš„ index.html..."
              git commit -m "ğŸ“ æ›´æ–° index.html (åŒ…å«æ‰€æœ‰æ­·å²æ—¥æœŸ)"
            fi

            # æ¨é€åˆ° gh-pages
            echo "æ¨é€ index.html åˆ° gh-pages..."
            git push origin gh-pages || {
              echo "::error::æ¨é€ index.html å¤±æ•—"
              exit 1
            }
          fi

          # åˆ‡å›ä¸»åˆ†æ”¯
          git checkout main
